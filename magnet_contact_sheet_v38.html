<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teddy's Magnets - 2"x2" Magnets Contact Sheet Combined V2</title>
  <meta name="icon" content="data:," />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 1500px; margin: 0 auto; }
    .toolbar { display: block; gap: 20px; align-items: center; padding: 5px 0; border: none; }
    .preview { border: 1px solid #ccc; margin-bottom: 20px; }
    .layer-panel { width: 819px; border: 1px solid #ccc; padding: 10px; }
    .left-panel { display: flex; flex-direction: column; gap: 15px; width: 500px; }
    canvas { border: 1px solid #000; }
    button { padding: 15px 30px; cursor: pointer; font-size: 18px; }
    #downloadButton { background-color: #007bff; color: white; border: none; border-radius: 4px; }
    #downloadButton:disabled { background-color: #cccccc; cursor: not-allowed; }
    #clearButton { background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 10px 20px; font-size: 14px; }
    .contactSheetPreview { width: 819px; height: 792px; }
    .contactSheetCanvas { display: none; }
    .customNameInput {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
    }
    .imageUrlInput {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      min-height: 100px;
    }
    .filenamePreview {
      margin-top: 5px;
      font-size: 0.9em;
      color: #888;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toolbar-title-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .toolbar-title-group h2 {
        margin: 0;
    }
    .layer-panel h2 {
        padding-top: 5px;
        padding-bottom: 5px;
        margin: 0;
    }

    /* Toggle Switch Styles */
    .toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .grayed-out-text {
        color: #888;
    }

    /* Individual Adjustments Grid Styles */
    .adjustment-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .adjustment-cell {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .adjustment-cell p {
      margin: 0 0 10px 0;
      font-size: 0.8em;
      font-weight: bold;
    }
    .adjustment-cell .toggle-container {
      width: 100%;
      margin-bottom: 5px;
    }
    .adjustment-cell label {
      font-size: 0.8em;
    }
    /* Expand/Collapse styles */
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 10px 0;
      border-top: 1px solid #000;
      border-bottom: 1px solid #000;
      margin-top: 5px;
    }
    .collapsible-header:first-child {
        margin-top: 0;
    }
    .collapsible-content {
      max-height: 650px;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    .collapsible-content.collapsed {
      max-height: 0;
    }
    .collapse-arrow {
      transition: transform 0.3s ease-in-out;
    }
    .collapse-arrow.collapsed {
      transform: rotate(-90deg);
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .hidden {
        display: none !important;
    }
    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .thumbnail-image {
        width: 100%;
        height: 80px;
        object-fit: contain;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
    }
    .thumbnail-image:hover {
        transform: scale(1.05);
    }
    .contact-sheet-section {
      border: 2px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .contact-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .contact-sheet-header h3 {
      margin: 0;
      color: #333;
    }
    .remove-sheet-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 15px;
      font-size: 14px;
      cursor: pointer;
    }
    .remove-sheet-btn:hover {
      background-color: #c82333;
    }
    #addSheetButton {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
    }
    #addSheetButton:hover {
      background-color: #218838;
    }
    .sheets-container {
      display: flex;
      gap: 20px;
    }
    .all-sheets-container {
      flex: 1;
    }
  </style>
</head>
<body>
  <h2>Teddy's Magnets - 2"x2" Magnets Contact Sheet Combined V2</h2>
  <div class="container" style="margin: 0;">
    <div class="sheets-container">
      <div class="all-sheets-container">
        <button id="addSheetButton" onclick="addContactSheet()">+ Add Another Contact Sheet</button>
        <div id="contactSheetsContainer"></div>
        <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-start; width: 500px;">
          <button id="downloadButton" onclick="confirmDownload()" disabled style="display: flex; align-items: center; justify-content: center; gap: 5px; padding: 10px 20px; font-size: 14px; width: 100%;">
            <span style="font-size: 20px; line-height: 1;">&darr;</span> Download All Contact Sheets
          </button>
          <button id="clearButton" onclick="clearAll()" style="display: flex; align-items: center; justify-content: center; gap: 5px; background-color: #f0f0f0; color: #555; border: 1px solid #ccc; border-radius: 4px; padding: 10px 20px; font-size: 14px; width: 100%;">
            <span style="font-size: 20px; line-height: 1;">&times;</span> Clear All
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let contactSheets = [];
    let sheetCounter = 0;
    let backgroundImage = new Image();
    const downloadButton = document.getElementById('downloadButton');

    // Auto-load the border image from the specified URL
    function loadDefaultBorderImage() {
      backgroundImage.crossOrigin = "anonymous";
      backgroundImage.onload = () => {
        updateAllPreviews();
      };
      backgroundImage.onerror = () => {
        console.warn('Could not load default border image from URL');
      };
      backgroundImage.src = 'https://cdn.shopify.com/s/files/1/0648/6209/3510/files/Teddys_Magnets_2.75x2.75_octaganal_magnets_border_with_url.png?v=1757688444';
    }

    function createContactSheet() {
      const sheetId = sheetCounter++;
      
      const sheet = {
        id: sheetId,
        images: [],
        imageBlobs: [],
        individualAdjustments: Array(9).fill(null).map(() => ({
          brightness5: false,
          brightness10: false,
          brightness15: false
        }))
      };

      contactSheets.push(sheet);
      renderContactSheet(sheet);
      updateDownloadButton();
      return sheet;
    }

    function renderContactSheet(sheet) {
      const container = document.getElementById('contactSheetsContainer');
      const sheetDiv = document.createElement('div');
      sheetDiv.className = 'contact-sheet-section';
      sheetDiv.id = `sheet-${sheet.id}`;
      
      sheetDiv.innerHTML = `
        <div class="contact-sheet-header">
          <h3>Contact Sheet ${contactSheets.indexOf(sheet) + 1}</h3>
          ${contactSheets.length > 1 ? `<button class="remove-sheet-btn" onclick="removeContactSheet(${sheet.id})">Remove</button>` : ''}
        </div>
        
        <div class="left-panel">
          <div class="collapsible-header" onclick="toggleSection(${sheet.id}, 'upload')">
            <b>Image URLs</b>
            <span id="uploadArrow-${sheet.id}" class="collapse-arrow">&#9660;</span>
          </div>
          <div id="uploadContent-${sheet.id}" class="collapsible-content">
            <div class="toolbar">
              <div>
                <label for="imageUrlInput-${sheet.id}">Paste Image URLs (comma-separated):</label>
                <textarea id="imageUrlInput-${sheet.id}" class="imageUrlInput" placeholder="e.g., https://example.com/image1.jpg, https://example.com/image2.jpg" oninput="handleUrlInput(${sheet.id})"></textarea>
              </div>
              <div id="thumbnail-preview-${sheet.id}" class="thumbnail-grid"></div>
              <div id="loading-spinner-${sheet.id}" class="loading-spinner hidden"></div>
            </div>
          </div>
          
          <div class="toolbar">
            <b>File Name Settings</b>
            <input type="text" id="customNameInput-${sheet.id}" class="customNameInput" placeholder="enter custom name" oninput="updatePreview(${sheet.id})">
            <div id="filenamePreview-${sheet.id}" class="filenamePreview"></div>
          </div>
          
          <div class="collapsible-header" onclick="toggleSection(${sheet.id}, 'adjustments')">
              <b>Image Adjustments</b>
              <span id="individualAdjustmentsArrow-${sheet.id}" class="collapse-arrow collapsed">&#9660;</span>
          </div>
          <div id="individualAdjustmentsContent-${sheet.id}" class="collapsible-content collapsed">
              <div class="checkbox-group">
                  <div class="checkbox-item toggle-container" style="margin-top: 10px; margin-bottom: 5px;">
                    <label for="recommendedCheckbox-${sheet.id}" style="font-weight: bold;">Recommended (Brighten All Images +10)</label>
                    <label class="switch">
                      <input type="checkbox" id="recommendedCheckbox-${sheet.id}" onchange="updateGlobalRecommendedCheckboxes(${sheet.id})">
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>
              <div class="toolbar">
                  <div class="adjustment-grid">
                      ${Array(9).fill(0).map((_, i) => `
                      <div class="adjustment-cell">
                          <p>Image ${i + 1}</p>
                          <div class="toggle-container">
                              <label>+5</label>
                              <label class="switch">
                                  <input type="checkbox" id="brightness5-${sheet.id}-${i}" onchange="updatePreview(${sheet.id});">
                                  <span class="slider"></span>
                              </label>
                          </div>
                          <div class="toggle-container">
                              <label>+10</label>
                              <label class="switch">
                                  <input type="checkbox" id="brightness10-${sheet.id}-${i}" onchange="updatePreview(${sheet.id});">
                                  <span class="slider"></span>
                              </label>
                          </div>
                          <div class="toggle-container">
                              <label>+15</label>
                              <label class="switch">
                                  <input type="checkbox" id="brightness15-${sheet.id}-${i}" onchange="updatePreview(${sheet.id});">
                                  <span class="slider"></span>
                              </label>
                          </div>
                      </div>
                      `).join('')}
                  </div>
              </div>
          </div>
        </div>
        
        <div class="layer-panel" style="margin-top: 15px;">
          <h2>Contact Sheet Preview</h2>
          <canvas id="contactSheetPreview-${sheet.id}" class="contactSheetPreview" width="819" height="792"></canvas>
          <canvas id="contactSheetCanvas-${sheet.id}" class="contactSheetCanvas" width="2550" height="3300"></canvas>
        </div>
      `;
      
      container.appendChild(sheetDiv);
      initCanvases(sheet.id);
      updatePreview(sheet.id);
    }

    function removeContactSheet(sheetId) {
      const index = contactSheets.findIndex(s => s.id === sheetId);
      if (index > -1) {
        contactSheets.splice(index, 1);
        document.getElementById(`sheet-${sheetId}`).remove();
        
        // Renumber remaining sheets
        contactSheets.forEach((sheet, idx) => {
          const header = document.querySelector(`#sheet-${sheet.id} .contact-sheet-header h3`);
          if (header) {
            header.textContent = `Contact Sheet ${idx + 1}`;
          }
        });
        
        updateDownloadButton();
      }
    }

    function addContactSheet() {
      createContactSheet();
    }

    function toggleSection(sheetId, section) {
      const content = document.getElementById(`${section === 'upload' ? 'uploadContent' : 'individualAdjustmentsContent'}-${sheetId}`);
      const arrow = document.getElementById(`${section === 'upload' ? 'uploadArrow' : 'individualAdjustmentsArrow'}-${sheetId}`);
      content.classList.toggle('collapsed');
      arrow.classList.toggle('collapsed');
    }

    function parseUrlString(urlString) {
      if (urlString.startsWith('You\'re about to visit:')) {
        return urlString.substring('You\'re about to visit:'.length).split(',').map(url => url.trim()).filter(url => url);
      } else if (urlString.startsWith('r2-image-urls:')) {
        return urlString.substring('r2-image-urls:'.length).split(',').map(url => url.trim()).filter(url => url);
      } else {
        return urlString.split(',').map(url => url.trim()).filter(url => url);
      }
    }

    function updateThumbnails(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      const urlString = document.getElementById(`imageUrlInput-${sheetId}`).value.trim();
      const urls = parseUrlString(urlString);
      const thumbnailPreview = document.getElementById(`thumbnail-preview-${sheetId}`);

      thumbnailPreview.innerHTML = '';
      
      if (urls.length > 0) {
        urls.slice(0, 9).forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Thumbnail preview';
          img.className = 'thumbnail-image';
          img.onerror = () => {
            img.style.display = 'none';
          };
          thumbnailPreview.appendChild(img);
        });
      }
    }

    async function handleUrlInput(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      updateThumbnails(sheetId);
      
      const urlString = document.getElementById(`imageUrlInput-${sheetId}`).value.trim();
      const urls = parseUrlString(urlString);
      
      if (urls.length === 0) {
        return;
      }

      showLoading(sheetId);
      
      sheet.images = [];
      sheet.imageBlobs = [];
      const urlsToLoad = urls.slice(0, 9);
      let loadedCount = 0;

      for (let index = 0; index < urlsToLoad.length; index++) {
        const url = urlsToLoad[index];
        try {
          const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(url);
          const response = await fetch(proxyUrl);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const blob = await response.blob();
          
          if (!blob.type.startsWith('image/')) {
            throw new Error('The URL did not point to a valid image file.');
          }

          sheet.imageBlobs[index] = blob;

          const img = new Image();
          img.onload = () => {
            sheet.images[index] = { img, x: 0, y: 0, width: img.width, height: img.height };
            loadedCount++;
            
            if (loadedCount === urlsToLoad.length) {
              checkAndCollapse(sheetId);
              if (sheet.images.length === 9) {
                document.getElementById(`recommendedCheckbox-${sheetId}`).checked = true;
                updateGlobalRecommendedCheckboxes(sheetId);
                const adjustmentsContent = document.getElementById(`individualAdjustmentsContent-${sheetId}`);
                const adjustmentsArrow = document.getElementById(`individualAdjustmentsArrow-${sheetId}`);
                adjustmentsContent.classList.remove('collapsed');
                adjustmentsArrow.classList.remove('collapsed');
              }
              updatePreview(sheetId);
              hideLoading(sheetId);
              updateDownloadButton();
            }
          };
          img.onerror = () => {
            console.error(`Error loading image from ${url}`);
            loadedCount++;
            if (loadedCount === urlsToLoad.length) {
              updatePreview(sheetId);
              hideLoading(sheetId);
              updateDownloadButton();
            }
          };
          img.src = URL.createObjectURL(blob);
        } catch (error) {
          console.error('Download error:', error);
          loadedCount++;
          if (loadedCount === urlsToLoad.length) {
            updatePreview(sheetId);
            hideLoading(sheetId);
            updateDownloadButton();
          }
        }
      }
    }

    function checkAndCollapse(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      if (sheet.images.length > 0 && backgroundImage.src) {
        const uploadContent = document.getElementById(`uploadContent-${sheetId}`);
        const uploadArrow = document.getElementById(`uploadArrow-${sheetId}`);
        uploadContent.classList.add('collapsed');
        uploadArrow.classList.add('collapsed');
      }
    }

    function showLoading(sheetId) {
      document.getElementById(`loading-spinner-${sheetId}`).classList.remove('hidden');
    }

    function hideLoading(sheetId) {
      document.getElementById(`loading-spinner-${sheetId}`).classList.add('hidden');
    }

    function updateGlobalRecommendedCheckboxes(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      const checked = document.getElementById(`recommendedCheckbox-${sheetId}`).checked;
      
      for (let i = 0; i < 9; i++) {
        const checkbox = document.getElementById(`brightness10-${sheetId}-${i}`);
        if (checkbox) {
          checkbox.checked = checked;
          sheet.individualAdjustments[i].brightness10 = checked;
        }
      }
      updatePreview(sheetId);
    }

    function updatePreview(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      
      for (let i = 0; i < 9; i++) {
        sheet.individualAdjustments[i].brightness5 = document.getElementById(`brightness5-${sheetId}-${i}`).checked;
        sheet.individualAdjustments[i].brightness10 = document.getElementById(`brightness10-${sheetId}-${i}`).checked;
        sheet.individualAdjustments[i].brightness15 = document.getElementById(`brightness15-${sheetId}-${i}`).checked;
      }
      
      drawContactSheetPreview(sheetId);
      updateFilenamePreview(sheetId);
      updateGlobalRecommendedCheckboxState(sheetId);
    }

    function updateAllPreviews() {
      contactSheets.forEach(sheet => updatePreview(sheet.id));
    }

    function updateGlobalRecommendedCheckboxState(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      const allRecommended = sheet.individualAdjustments.every(adj => adj.brightness10);
      document.getElementById(`recommendedCheckbox-${sheetId}`).checked = allRecommended;
    }

    function initCanvases(sheetId) {
      const contactSheetCanvas = document.getElementById(`contactSheetCanvas-${sheetId}`);
      const contactSheetCtx = contactSheetCanvas.getContext('2d');
      const contactSheetPreview = document.getElementById(`contactSheetPreview-${sheetId}`);
      const previewCtx = contactSheetPreview.getContext('2d');
      
      contactSheetCtx.fillStyle = '#fff';
      contactSheetCtx.fillRect(0, 0, 2550, 3300);
      previewCtx.fillStyle = '#fff';
      previewCtx.fillRect(0, 0, 819, 792);
    }

    function adjustImage(image, targetSize, brightnessFactor) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = targetSize;
      tempCanvas.height = targetSize;
      const tempCtx = tempCanvas.getContext('2d');
      
      let sourceX = 0;
      let sourceY = 0;
      let sourceWidth = image.width;
      let sourceHeight = image.height;
      
      const imageAspectRatio = image.width / image.height;
      if (imageAspectRatio > 1) {
        sourceWidth = image.height;
        sourceX = (image.width - sourceWidth) / 2;
      } else if (imageAspectRatio < 1) {
        sourceHeight = image.width;
        sourceY = (image.height - sourceHeight) / 2;
      }

      tempCtx.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetSize, targetSize);
      
      let imageData = tempCtx.getImageData(0, 0, targetSize, targetSize);
      let data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, data[i] * brightnessFactor);
        data[i + 1] = Math.min(255, data[i + 1] * brightnessFactor);
        data[i + 2] = Math.min(255, data[i + 2] * brightnessFactor);
      }
      
      tempCtx.putImageData(imageData, 0, 0);
      return tempCanvas;
    }

    function drawContactSheetPreview(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      const contactSheetPreview = document.getElementById(`contactSheetPreview-${sheetId}`);
      const previewCtx = contactSheetPreview.getContext('2d');
      
      previewCtx.fillStyle = '#fff';
      previewCtx.fillRect(0, 0, 819, 792);
      const marginTop = 74.25;
      const hSpacing = 15.5;
      const vSpacing = 34.1;
      const size = 198;
      const photoSize = 158;
      const marginSide = (819 - (3 * size + 2 * hSpacing)) / 2;
      const positions = [
        [marginSide, marginTop],
        [marginSide + size + hSpacing, marginTop],
        [marginSide + 2 * size + 2 * hSpacing, marginTop],
        [marginSide, marginTop + size + vSpacing],
        [marginSide + size + hSpacing, marginTop + size + vSpacing],
        [marginSide + 2 * size + 2 * hSpacing, marginTop + size + vSpacing],
        [marginSide, marginTop + 2 * size + 2 * vSpacing],
        [marginSide + size + hSpacing, marginTop + 2 * size + 2 * vSpacing],
        [marginSide + 2 * size + 2 * hSpacing, marginTop + 2 * size + 2 * vSpacing]
      ];
      
      positions.forEach((pos, index) => {
        if (backgroundImage.complete && backgroundImage.src) {
          previewCtx.drawImage(backgroundImage, pos[0], pos[1], size, size);
        } else {
          previewCtx.fillStyle = '#e0e0e0';
          previewCtx.fillRect(pos[0], pos[1], size, size);
        }

        if (sheet.images[index]) {
          const adj = sheet.individualAdjustments[index];
          let brightnessFactor = 1.0;
          if (adj.brightness5) brightnessFactor = 1.05;
          if (adj.brightness10) brightnessFactor = 1.10;
          if (adj.brightness15) brightnessFactor = 1.15;
          
          const adjustedImage = adjustImage(sheet.images[index].img, 660, brightnessFactor);
          const offset = (size - photoSize) / 2;
          previewCtx.drawImage(adjustedImage, pos[0] + offset, pos[1] + offset, photoSize, photoSize);
        }
      });
      
      const previewFilename = generateFilename(sheetId);
      previewCtx.fillStyle = '#000';
      previewCtx.font = 'bold 10px Arial';
      previewCtx.textAlign = 'center';
      previewCtx.fillText(previewFilename, contactSheetPreview.width / 2, 40);
    }

    function generateContactSheet(sheetId) {
      const sheet = contactSheets.find(s => s.id === sheetId);
      const contactSheetCanvas = document.getElementById(`contactSheetCanvas-${sheetId}`);
      const contactSheetCtx = contactSheetCanvas.getContext('2d');
      
      contactSheetCtx.fillStyle = '#fff';
      contactSheetCtx.fillRect(0, 0, 2550, 3300);
      const marginTop = 309.5;
      const hSpacing = 29.25;
      const vSpacing = 141.9;
      const size = 825;
      const photoSize = 660;
      const marginSide = (2550 - (3 * size + 2 * hSpacing)) / 2;
      const positions = [
        [marginSide, marginTop],
        [marginSide + size + hSpacing, marginTop],
        [marginSide + 2 * size + 2 * hSpacing, marginTop],
        [marginSide, marginTop + size + vSpacing],
        [marginSide + size + hSpacing, marginTop + size + vSpacing],
        [marginSide + 2 * size + 2 * hSpacing, marginTop + size + vSpacing],
        [marginSide, marginTop + 2 * size + 2 * vSpacing],
        [marginSide + size + hSpacing, marginTop + 2 * size + 2 * vSpacing],
        [marginSide + 2 * size + 2 * hSpacing, marginTop + 2 * size + 2 * vSpacing]
      ];
      
      sheet.images.slice(0, 9).forEach((image, index) => {
        if (backgroundImage.complete && backgroundImage.src) {
          contactSheetCtx.drawImage(backgroundImage, positions[index][0], positions[index][1], size, size);
        }
        if (image) {
          const adj = sheet.individualAdjustments[index];
          let brightnessFactor = 1.0;
          if (adj.brightness5) brightnessFactor = 1.05;
          if (adj.brightness10) brightnessFactor = 1.10;
          if (adj.brightness15) brightnessFactor = 1.15;
          
          const adjustedImage = adjustImage(image.img, 660, brightnessFactor);
          const offset = (size - photoSize) / 2;
          contactSheetCtx.drawImage(adjustedImage, positions[index][0] + offset, positions[index][1] + offset, photoSize, photoSize);
        }
      });
      
      const filename = generateFilename(sheetId);
      contactSheetCtx.fillStyle = '#000';
      contactSheetCtx.font = 'bold 40px Arial';
      contactSheetCtx.textAlign = 'center';
      const sheetWidth = 2550;
      const textX = sheetWidth / 2;
      contactSheetCtx.fillText(filename, textX, 150);
    }

    function generateFilename(sheetId) {
      const customName = document.getElementById(`customNameInput-${sheetId}`).value.trim();
      const sheet = contactSheets.find(s => s.id === sheetId);
      const adjustments = [];
      const isRecommended = document.getElementById(`recommendedCheckbox-${sheetId}`).checked;
      const isCustom = sheet.individualAdjustments.some(adj =>
        (adj.brightness10 !== isRecommended) ||
        (adj.brightness5 !== false) ||
        (adj.brightness15 !== false)
      );
      
      if (isCustom) {
        adjustments.push("Custom Adjustments");
      } else if (isRecommended) {
        adjustments.push("Recommended");
      } else {
        adjustments.push("no adjustments");
      }

      let namePart = customName ? `${customName} ` : '';
      let adjustmentsPart = adjustments.join(' ');
      
      return `${namePart}contact sheet ${adjustmentsPart}.png`;
    }

    function updateFilenamePreview(sheetId) {
      const filenamePreview = document.getElementById(`filenamePreview-${sheetId}`);
      filenamePreview.textContent = `Filename: ${generateFilename(sheetId)}`;
    }

    function updateDownloadButton() {
      const hasImages = contactSheets.some(sheet => sheet.images.length > 0);
      downloadButton.disabled = !hasImages;
    }

    function confirmDownload() {
      const incompleteSheets = contactSheets.filter(sheet => sheet.images.length > 0 && sheet.images.length < 9);
      if (incompleteSheets.length > 0) {
        if (confirm("Some contact sheets are not complete. Are you sure you want to download?")) {
          downloadAllContactSheets();
        }
      } else {
        downloadAllContactSheets();
      }
    }

    async function downloadAllContactSheets() {
      const sheetsWithImages = contactSheets.filter(sheet => sheet.images.length > 0);
      
      if (sheetsWithImages.length === 0) {
        console.error('Please upload at least 1 image to download.');
        return;
      }
      
      try {
        // Use the first sheet's custom name as the ZIP folder name
        const firstCustomName = document.getElementById(`customNameInput-${sheetsWithImages[0].id}`).value.trim();
        const zipFolderName = firstCustomName || 'customer_images';
        
        // Create ZIP file
        const zip = new JSZip();
        const topLevelFolder = zip.folder(zipFolderName);
        
        // Process each sheet
        for (let i = 0; i < sheetsWithImages.length; i++) {
          const sheet = sheetsWithImages[i];
          
          // Generate and add contact sheet
          generateContactSheet(sheet.id);
          const contactSheetCanvas = document.getElementById(`contactSheetCanvas-${sheet.id}`);
          const contactSheetDataURL = contactSheetCanvas.toDataURL('image/png');
          const contactSheetBlob = await (await fetch(contactSheetDataURL)).blob();
          topLevelFolder.file(generateFilename(sheet.id), contactSheetBlob);
          
          // Create Originals folder (Originals, Originals 2, Originals 3, etc.)
          const originalsFolderName = i === 0 ? 'Originals' : `Originals ${i + 1}`;
          const originalsFolder = topLevelFolder.folder(originalsFolderName);
          
          // Add original images
          for (let j = 0; j < sheet.imageBlobs.length; j++) {
            if (sheet.imageBlobs[j]) {
              const filename = `image_${j + 1}.jpg`;
              originalsFolder.file(filename, sheet.imageBlobs[j]);
            }
          }
        }
        
        // Generate and download ZIP
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `${zipFolderName}.zip`);
        
        // Clear all after successful download
        setTimeout(() => {
          clearAll();
        }, 500);
        
      } catch (error) {
        console.error('Error downloading contact sheets:', error);
        alert('Failed to download contact sheets. Ensure all images are uploaded and the border image is loaded.');
      }
    }

    function clearAll() {
      contactSheets = [];
      document.getElementById('contactSheetsContainer').innerHTML = '';
      sheetCounter = 0;
      createContactSheet();
      updateDownloadButton();
    }

    // Initialize with one contact sheet
    loadDefaultBorderImage();
    createContactSheet();
  </script>
</body>
</html>
